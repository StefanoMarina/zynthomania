<!doctype html>

<html>
  <head>
    <link href="lnf.css" rel="stylesheet">
    <link href="bootstrap-grid.min.css" rel="stylesheet">
    <link href="fontawesome-free-5.15.3-web/css/all.css" rel="stylesheet">
    
    <script src="jquery/dist/jquery.min.js"></script>
    <script src="jquerySwipeHandler.js"></script>
    <script src="lcdknob.js"></script>
    <script src="fxbutton.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ZynthoMania!</title>
  </head>

  <body>
    <input id="currentInstrument" type="hidden">
    
    <div class="">
      <div class="row no-gutters">
        
        <div class="col-12"> <!-- main body -->
          
          <table class="col-12 toolbar">
            <tr>
              <td><button id="btnDoFavorite"><i class="far fa-star big-icon"></i></button></td>
              <td><button onclick="onChangePart(-1)" class="big-btn">&lt;</button></td>
              <td><span id="currentPart" class="big-btn">1</span></td>
              <td><button onclick="onChangePart(1)" class="big-btn">&gt;</button></td>
            </tr>
          </table>
        
        <div class="col-12"><h3><span id="instrumentName">Welcome to Zynthomania! </span></h3></div>        
        
          <div class="row">
            <div class="col-12 tab">
              <header class="d-flex flex-row tab-h">
                <button class="tab-header" data-tab="controlPanel" data-open="pnlBanks" id="btnBanks"><a>Banks</a></button>
                <button class="tab-header" data-tab="controlPanel" data-open="pnlFX" id=""><a>FX</a></button>
                <button class="tab-header" data-tab="controlPanel" id=""><a>OSC</a></button>
                <button class="tab-header" data-tab="controlPanel" data-open="pnlScript"><a>Script</a></button>
                <button class="tab-header" data-tab="controlPanel" data-open="pnlSystem"><a>System</a></button>
              </header>
            
            <!--panels-->
              <div id="pnlBanks" class="row controlPanel no-gutters hidden">
                  <ul id="selBanks" class="select col-6 col-xs-6"></ul>
                  <ul id="selInstruments" class="select col-6 col-xs-6 hidden"></ul>
              </div>
              
              <div id="pnlFX" class="tab row no-gutters controlPanel hidden">
                <header class="col-4 no-gutters tab-v br">
                  <button class="tab-header" data-tab="fxPanel" data-open="pnlDry" onclick="onDryPanelLoad()")>Dry</button>
                  <button class="tab-header" data-tab="fxPanel" data-open="pnlPart" onclick="queryPartFX()">Part</button>
                  <button class="tab-header" data-tab="fxPanel" data-open="pnlRoute" onclick="onRoutePanelLoad()">Route</button>
                  <button class="tab-header" data-tab="fxPanel" data-open="pnlSystemFX" onclick="querySystemFX()">System</button>
                </header>
                <div class="col-8"> <!-- fx content container -->
                  
                  <div id="pnlDry" class="panel fxPanel hidden row">
                    <div class="col-12 col-md-6"><button class="col-12 big-btn toggle btnDrySelection">Reverb</button></div>
                    <div class="col-12 col-md-6"><button class="col-12 big-btn toggle btnDrySelection">Echo</button></div>
                    <div class="col-12 col-md-6"><button class="col-12 big-btn toggle btnDrySelection">Chorus</button></div>
                    <div class="col-12 col-md-6"><button class="col-12 big-btn toggle btnDrySelection">Phaser</button></div>
                    <div class="col-12 col-md-6"><button class="col-12 big-btn toggle btnDrySelection">Distorsion</button></div>
                    <div class="col-12 col-md-6"><button class="col-12 big-btn toggle btnDrySelection">EQ</button></div>
                    <div class="col-12 col-md-6"><button class="col-12 big-btn toggle btnDrySelection">DynamicFilter</button></div>
                    <div class="col-12 col-md-6">
                      <button class="col-12 big-btn btn-selected" id="applyDry">Dry <i class="fa fa-level-down-alt"></i>
                      </button>
                    </div>
                  </div>
                  <div id="pnlPart" class="panel fxPanel hidden row">
                    <div class="col-12">
                      <div class="fx-btn row no-gutters col-12 big-btn" data-group="pfx" id="btnpfx0"></div>
                      <div class="fx-btn row no-gutters col-12 big-btn" data-group="pfx" id="btnpfx1"></div>
                      <div class="fx-btn row no-gutters col-12 big-btn" data-group="pfx" id="btnpfx2"></div>
                    </div>
                    <div class="row col-12">
                      <div class="col-3 col-md-2"><button class="knob" id="kss0"></button></div>
                      <div class="col-3 col-md-2"><button class="knob" id="kss1"></button></div>
                      <div class="col-3 col-md-2"><button class="knob" id="kss2"></button></div>
                      <div class="col-3 col-md-2"><button class="knob" id="kss3"></button></div>
                      <div class="col-12 col-sm-2"><button onclick="actionMaximizeSend()">Send &gt; </button></div>
                    </div>
                  </div>
                  <div id="pnlSystemFX" class="panel fxPanel hidden row">
                    <div class="col-12">
                      <div class="fx-btn row no-gutters col-12 big-btn" data-group="pfx" id="btnsfx0"></div>
                      <div class="fx-btn row no-gutters col-12 big-btn" data-group="pfx" id="btnsfx1"></div>
                      <div class="fx-btn row no-gutters col-12 big-btn" data-group="pfx" id="btnsfx2"></div>
                      <div class="fx-btn row no-gutters col-12 big-btn" data-group="pfx" id="btnsfx3"></div>
                    </div>
                  </div>         
                  <div id="pnlRoute" class="panel fxPanel hidden row">
                    <div class="col-6 col-md-8 align:center"><h3 style="text-align:center">Send to master</h3></div>
                    <div class="col-6 col-md-4"><button class="col-12 knob" id="routeSend"></button></div>
                    <div class="col-12">
                      <h3 class="check" data-check="0">Send to all</h3>
                    </div>
                    
                    <div class="col-12 col-md-6"><button class="col-12 big-btn toggle btnRouteSelection">Reverb</button></div>
                    <div class="col-12 col-md-6"><button class="col-12 big-btn toggle btnRouteSelection">Echo</button></div>
                    <div class="col-12 col-md-6"><button class="col-12 big-btn toggle btnRouteSelection">Chorus</button></div>
                    <div class="col-12 col-md-6"><button class="col-12 big-btn toggle btnRouteSelection">Phaser</button></div>
                    <div class="col-12 col-md-6"><button class="col-12 big-btn toggle btnRouteSelection">Distorsion</button></div>
                    <div class="col-12 col-md-6"><button class="col-12 big-btn toggle btnRouteSelection">EQ</button></div>
                    <div class="col-12 col-md-6"><button class="col-12 big-btn toggle btnRouteSelection">DynamicFilter</button></div>
                    <div class="col-12 col-md-6">
                      <button class="col-12 big-btn btn-selected" id="applyRoute">Apply <i class="fa fa-level-down-alt"></i>
                      </button>
                    </div>
                  </div>
                </div> <!-- /fx content -->
              </div> <!-- /fx -->
              
              <div id="pnlScript" class="tab row no-gutters controlPanel hidden">
                <div class="col-10">
                  <label for="commandline">&gt;</label>
                  <input id="commandLine" placeholder="Input parameter...">
                </div>
                <div class="col-2">
                  <button onclick="onScriptSend();">Send</button>
                </div>
              </div>
              
              
              <div id="pnlSystem" class="tab row no-gutters controlPanel hidden">
                <header class="col-4 no-gutters tab-v br">
                  <button class="tab-header" data-tab="fxPanel" data-open="pnlMIDI" onclick="onMIDIPanelLoad();")>MIDI</button>
                </header>
                <div class="col-8"> <!-- fx content container -->
                  <div id="pnlMIDI" class="panel hidden row">
                    <div class="col-12" id="sysMidiContainer">
                    </div>
                  </div>
                </div>
            </div> 
          </div> 
        </div> <!--col-10 -->        
      </div><!-- main row -->
    </div> <!--container-->
    <script type="text/javascript">
      
      window.zsession = {
        "instrument" : {}, //curent instrument
        "bank" : '', //current bank
        "partID": 0, //current part id
        "partefx" : new Array(15), //last part efx query
         fx : { path : ''}, //fx panel data
         banks : {} //banks panel data
      };
      
      /*window.zsession.getPart = function(id) {
        if (id === undefined)
          id = window.zsession.partID;
        
        if (window.zsession.parts[id] === undefined)
          window.zsession.parts[id] == { partefx : []}
        
        return window.zsession.parts[id];
      }*/
      
      window.zsession.sanitize = function (path) {
        if (path.search('part/') > 0)
          path = path.replace('part/', `part${window.zsession.partID}/`)
        
        return path;
      }
      
      window.zsession.fx.getFX =function (id) {
        if (id === undefined)
          id = window.zsession.fx.id;
          
        if (window.zsession.fx.path.search('partefx')>0)
          return window.zsession.partefx[window.zsession.partID].fx[id];
        else
          return undefined;
      }
      
      window.zsession.fx.setFX = function (object, id) {
        if (id === undefined)
          id = window.zsession.fx.id;
          
        if (window.zsession.fx.path.search('partefx')>0)
          window.zsession.partefx[window.zsession.partID].fx[id] = object;
      }
      
      /* create a Instrument object */
      function listToInstrument(item) {
        if ('li' != $(item).prop('tagName').toLowerCase()) {
          console.log('Error: cannot translate item ' + $(item).prop('tagName'));
          return;
        }
        return {
          "path": $(item).attr('data-instrument'),
          "name" : $(item).text()
        }
      }
      
      /* Quickie to check if instrument if favorite */
      function isFavorite(instrument) {
        if (window.zsession.banks['Favorites'] === undefined ||
            window.zsession.banks['Favorites'].length == 0)
        return false;
        
        return window.zsession.banks['Favorites'].filter
                ((fav)=> {return fav.path == instrument.path})
            .length > 0;
      }
      
      const isObject = (obj) => {
        return Object.prototype.toString.call(obj) === '[object Object]';
      };
      
      /* Utility to do GET rest methods */
      function doQuery(rest, data, onDone) {
        return doAjax({method:'get', dataType: 'json', 
                  url: window.location.href+rest, 
                  data: data,
                  contentType: 'application/json; charset=utf-8'
        }, onDone);
      }
      
      function doAction(rest, data, onDone) {
        return doAjax( {method: 'post', 
          url: window.location.href+rest,
          data: JSON.stringify(data),
          contentType: 'application/json; charset=utf-8'
          }, onDone );
      }
      
      /* ajax function */
      function doAjax(params, onDone) {
        const oldValue = $('#instrumentName').text();
        $('#instrumentName').text('.');
        
        const timer = setInterval ( () =>{
          
          let text = $('#instrumentName').text();
          
          if (text.length < 8)
            text += "..";
          else {
            padding = parseInt( /(\d+)px/.exec($('#instrumentName').css('padding-left'))[1] )
            if (padding < 100)
              $('#instrumentName').css('padding-left', padding+10);
            else {
              $('#instrumentName').css('padding-left', 0);
              text = "..";
            }
          }
            
          $('#instrumentName').text(text);
        }, 500);
        
        $.ajax(params)
        .done(function(data) {
            clearInterval(timer);
            $('#instrumentName').text('OK');
            $('#instrumentName').css('padding-left' , 0);
            
            if (onDone !== undefined)
              onDone(data);
          })
        .fail( function(jqXHR, textStatus, errorThrown) {
          clearInterval(timer);
          $('#instrumentName').text(`Error #${errorThrown}`);  
        });
      }
      
      function onChangePart(index) {
        if (window.zsession.partID+index < 0)
          window.zsession.partID = 15;
        else if (window.zsession.partID+index > 15)
          window.zsession.partID = 0;
        else
          window.zsession.partID += index;
        $('#currentPart').text( ('0'+window.zsession.partID).substr(-2) );
        
        //retrieve part info
        doQuery('status/part', {id: window.zsession.partID}, (data) => {
          console.log(data);
          if (data.name == '') data.name = 'Unloaded';
          $('#instrumentName').text(`#${window.zsession.partID}: ${data.name}`);
        });
        
        //any active panel must be re-triggered
        $('.controlPanel tab-header.btn-selected').trigger('click');
      }
      
      /** loads part fx */
      function queryPartFX() {
        doQuery('status/partfx', {id: window.zsession.partID}, function(data){
          console.log(data);
            window.zsession.partefx[window.zsession.partID] = {fx : data.efx, send : data.send }
            //onFXLoad('btnpfx', data);
            
            for (let i = 0; i < 3; i++)
              window.buttons[`btnpfx${i}`].setFX(data.efx[i]);
            
            //update send
            for (let i = 0; i < 4; i++) {
                let id = `kss${i}`;
                console.log(data.send[i]);
                window.knobs[id].setValue(data.send[i]);
            }
            
        });
      }
  
      function querySystemFX() {
         doQuery('status/systemfx', undefined, function(data){
          console.log(data);
            //window.zsession.partefx[window.zsession.partID] = {fx : data.efx, send : data.send }
            //onFXLoad('btnpfx', data);
            
            for (let i = 0; i < 4; i++)
              window.buttons[`btnsfx${i}`].setFX(data.efx[i]);
        });
      }
     
     function actionMaximizeSend() {
       let script = `/Psysefxvol[0-3]/part${window.zsession.partID} 127`;
       doAction('script', {script: script}, (data) => {
         window.knobs['kss0'].setValue(127);
         window.knobs['kss1'].setValue(127);
         window.knobs['kss2'].setValue(127);
         window.knobs['kss3'].setValue(127);
       })
     }
      
      /* Bank button load */
      function queryBankList() {
        
        //Banks preloading
        if (Object.keys(window.zsession.banks).length <= 1) {
          doQuery('getBanks', null, (data) => {
            data.forEach( (item) => {
              window.zsession.banks[item] = [];
            });
            queryBankList(-1);
            return;
          })
          
          return;
        }
        
        let banks = window.zsession.banks;
        let entry = '';
        let selectObject = $('#selBanks');
        selectObject.empty();
            
        Object.keys(banks).forEach( (key) => {
          selectObject.append('<li data-bank="'+key+'">'+key+'</li>');
      
        });
             
         $('.controlPanel').addClass('hidden');
         $('#pnlBanks').removeClass('hidden');
      }
      
      function onPartSendChange(id) {
        console.log('called!')
        let newValue = window.knobs[`kss${id}`].getValue();
        doAction('script', {script : `/Psysefxvol${id}/part${window.zsession.partID} ${newValue}` });
      }
      
      function queryBank(selectedBank) {
        
        if (window.zsession.banks[selectedBank].length == 0) {
          doQuery('getInstruments', {bank: selectedBank}, (data) => {
            window.zsession.banks[selectedBank] = data;
            
            if (data.length == 0) {
              $('#instrumentName').text('Empty!');
              return;
            }
            
            queryBank(selectedBank);
            return;
          });
          return;
        }

        window.zsession.bank = selectedBank;
        
        let instruments = window.zsession.banks[selectedBank];
        let entry = '';
        let selectObject = $('#selInstruments');
        selectObject.empty();
        
        instruments.forEach( (value, index, array) => {
          let entry = `<li data-instrument="${value.path}">${value.name}`;
                
          if (isFavorite(value))
            entry += '<span style="float:right"><i class="fas fa-star"></i></span>';
            
           selectObject.append(entry+"</li>");
           selectObject.removeClass('hidden');
        });
      }
      
      function onInstrumentSelection(instrument) {
        doAction("loadInstrument", {'instrument': instrument, 
          'id': window.zsession.partID}, (data) => {
            console.log('done');
//             $('#instrumentName').text(instrument.name);
              window.zsession.instrument = instrument;    
              $('#btnDoFavorite i').removeClass('far fas');
              $('#btnDoFavorite i').addClass( (isFavorite(instrument)) 
                                        ? 'fas' : 'far');
              onChangePart(0);
          })
        }

      function onScriptSend() {
        let data = $('#commandLine').val();
        doAjax({method:'post', url: window.location.href+"script",
                data: JSON.stringify({script: data}), 
                contentType: 'application/json; charset=utf-8'},
                function(){
        });
      }
      function setFavorite (instrument, value) {
        let action = (value) ? 'set' : 'unset';
        
        //First, we update server
        doAjax({method:'post', url: window.location.href+"setFavorite",
                data: JSON.stringify({"instrument":instrument, "action": action}), 
                contentType: 'application/json; charset=utf-8'},
        function() {
          
          //Then we update client, without ajax
          if (!value) {
            window.zsession.banks['Favorites']= 
            window.zsession.banks.Favorites.filter( (entry) => {
              return (entry.path != instrument.path);});
          } else {
            window.zsession.banks.Favorites.push(instrument);
          }
          
          //last we update display
          if (instrument.name == window.zsession.instrument.name) {
            $('#btnDoFavorite i').removeClass('far fas');
            $('#btnDoFavorite i').addClass((value == true) ? 'fas' : 'far'); 
          }
          
          let li = $('#selInstruments li.btn-selected');
          if (li !== undefined && li.attr('data-instrument') == instrument.path) {
            $(li).empty();
            $(li).text(instrument.name);
            if (value)
              $(li).append('<span style="float:right"><i class="fas fa-star"></i></span>');
          }
        });
      }
      
      
      function onDryPanelLoad() {
        doQuery('status/options', null, (data) => {
          console.log(data);
          let fxes = data.dry;
          $('.btnDrySelection').removeClass('btn-selected');
          
          fxes.forEach( (fx) => {
              $(`.btnDrySelection:contains(${fx})`).addClass('btn-selected');
          })
        });
      }
      
      function onRoutePanelLoad() {
        doQuery('status/options', null, (data) => {
          console.log(data);
          let route = data.route;
          
          let fxes = route.fx;
          
          $('.btnRouteSelection').removeClass('btn-selected');
          
          fxes.forEach( (fx) => {
              $(`.btnRouteSelection:contains(${fx})`).addClass('btn-selected');
          })
          
          window.knobs['routeSend'].setValue(route.send);
        });
      }
      
      function onMIDIPanelLoad() {
        doQuery('status/midi', null, (data) => {
          
//          data = JSON.parse(data);
          if (Object.prototype.toString.call(data) !== '[object Array]') {
            console.log("Error: data is not array.");
            console.log(data);
            return;
          }
          
          //data is array
          let midiCont = $('#sysMidiContainer');
          $(midiCont).empty();
          
          
          data.forEach( (item) => {
            
            let plugged = (item.connections !== undefined && 
                      item.connections.indexOf(zynConnection.plug) > -1);
            let selClass = (item.connected) ? "btn-selected" : "";
            
            let content = `<button class="col-sm-12 col-md-8 col-lg-6 ${selClass}" value="${item.port}">${item.name}`+"</button>";
            $(midiCont).append(content);
          });
          
          $(midiCont).children('button').on('click', (e) => {
            let target = $(e.target);
            let plugged = $(target).hasClass('btn-selected');
            
            doAction('status/midi/plug', 
              {'name': $(target).val(), 'status': !plugged}, (data) =>{
                onMIDIPanelLoad();
              });
          });
        });
      }
      
      /**
       Init 
       */
           
      $(document).ready( init );
        
      function init() {
        
        /**
         Knobs initialization
         */
        window.knobs = {};
        //Create knobs
        $('.knob').each( function () {
          let id = $(this).attr('id')
          let knob = new LCDKnob(id);
          knob.setValue(0);
          knob.render();
          window.knobs[id] = knob;
          
          $(`#${id}`).on('click', () => {
            window.knobs[id].next();
            $(`#${id}`).trigger({type:'knob-change', id: id});
          });
        })
        
        $('#kss0, #kss1, #kss2, #kss3').on('knob-change', (e) => {
          onPartSendChange(/kss(\d)/.exec(e.id)[1]);
        });
        
        /**
        FX buttons
        */
        window.buttons = {};
        
        $('.fx-btn').each( function (index) {
          let id = $(this).attr('id');
          let chid = parseInt(/\w+(\d+)/.exec(id)[1]);
          let fxButton = new FXButton(id, chid);
          window.buttons[id] = fxButton;
        });
        
        //Part efx
        $('#btnpfx0, #btnpfx1, #btnpfx2').each( function (index) {
          let id = $(this).attr('id');
          window.buttons[id].base_path = '/part/partefx';
        });
        
        //system efx
        $('#btnsfx0, #btnsfx1, #btnsfx2 #btnsfx3').each( function (index) {
          let id = $(this).attr('id');
          window.buttons[id].base_path = '/sysefx';
        });
        
        /**
        Tab button management
        **/
          $('.tab-header').on('click', function() {
            let tab = $(this).closest('.tab');
            
            $(tab).find('> header .tab-header').removeClass('btn-selected');
            $(this).addClass('btn-selected');
            
            if ( $(this).attr('data-open') !== undefined) {
              let className= $(this).attr('data-tab');
              $('.'+className).addClass('hidden');
              $('#'+$(this).attr('data-open')).removeClass('hidden');
            }
          });
          
          
          //Double filter is necessary or new elements won't be looked up
          $('ul.select').on('click', 'li', function(e){
            var item = $(e.target);
            item.addClass('btn-selected');
            item.siblings().removeClass('btn-selected');
            //eventId = '#' + $(item).parent().attr('data-event-id');
            //$(eventId).val(item.text());
          });
          
          /**
          Button actions
          */
          $('#btnBanks').on('click', function() { queryBankList(); });
          $('#selBanks').on('click', 'li', function(e) {
            queryBank($(e.target).attr('data-bank'));
          });
          $('#selInstruments').on('click', 'li', function(e) {
            
            if ('span' == $(e.target).prop('tagName').toLowerCase()
                  || 'i' == $(e.target).prop('tagName').toLowerCase()) {
                    
              let instrument = listToInstrument($(e.target).closest('li'));
              setFavorite(instrument, false);
            } else
              onInstrumentSelection(listToInstrument($(e.target)));
          });
          
          $('#btnDoFavorite').on('click', function(){
            let instrument = window.zsession.instrument;
            setFavorite(instrument, (!isFavorite(instrument)));
          });
         
        
          $('.check').on('click', function() {
            $(this).attr('data-check', $(this).attr('data-check') == 'true' ? 'false' : 'true');
            console.log('check!');
          });
          
          $('.toggle').on('click', function() {
            if( $(this).hasClass('btn-selected'))
              $(this).removeClass('btn-selected');
            else {
              let group = $(this).attr('data-group');
              if ( group !== undefined)
                $(`.toggle[data-group=${group}]`).removeClass('btn-selected');
              $(this).addClass('btn-selected');
            }
          })
        
          
          $('#applyRoute').on('click', function() {
            const route = {};
            route.send = window.knobs['routeSend'].getValue();
            route.fx = $.makeArray(
            $('.btnRouteSelection.btn-selected').map( function() {return $(this).text()})
            );
            
            //console.log(route);
            doAction('fx/route', {route: route});
          })
          $('#applyDry').on('click', function() {
            const dry = $.makeArray(
              $('.btnDrySelection.btn-selected').map( function() {return $(this).text()})
            );
            
            doAction('fx/dry', {dry: dry});
          })
            
          /**
          Init actions
          - get favorites
          - update part names
          */
          doQuery('getInstruments', {bank: 'Favorites'}, 
            function(data) {
              window.zsession.banks['Favorites'] = data;
              //$('#instrumentName').text('Welcome to Zynthomania!');
              onChangePart(0);
          });
          
       
      }
    </script>
  </body>
</html>
