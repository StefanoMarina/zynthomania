<!doctype html>


<html>
  <head>
    <link href="lnf.css" rel="stylesheet">
    <link href="bootstrap-grid.min.css" rel="stylesheet">
    <link href="fontawesome-5-css/css/fontawesome-all.css" rel="stylesheet">
    <script src="jquery/dist/jquery.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>

  <body>
    <input id="currentInstrument" type="hidden">
    
    <div class="container">
      <div class="row no-gutters">
        
        <div class="col-12"> <!-- main body -->
          
          <table class="col-12 toolbar">
            <tr>
              <td><button id="btnDoFavorite"><i class="far fa-star big-btn"></i></button></td>
              <td><button onclick="onChangePart(-1)" class="big-btn">&lt;</button></td>
              <td><span id="currentPart" class="big-btn">1</span></td>
              <td><button onclick="onChangePart(1)" class="big-btn">&gt;</button></td>
            </tr>
          </table>
        
        <div class="col-12"><h3><span id="instrumentName">Welcome to Zynthomania! </span></h3></div>        
        
          <div class="row">
            <div class="col-12 tab">
              <header class="d-flex flex-row tab-h">
                <button class="tab-header" data-tab="controlPanel" data-open="pnlBanks" id="btnBanks"><a>Banks</a></button>
                <button class="tab-header" data-tab="controlPanel" data-open="pnlFX" id=""><a>FX</a></button>
                <button class="tab-header" data-tab="controlPanel" id=""><a>OSC</a></button>
                <button class="tab-header" data-tab="controlPanel" id=""><a>Instruments</a></button>
                <button class="tab-header" data-tab="controlPanel" data-open="pnlScript"><a>Script</a></button>
              </header>
            
            <!--panels-->
              <div id="pnlBanks" class="row controlPanel no-gutters hidden">
                  <ul id="selBanks" class="select col-6 col-xs-6"></ul>
                  <ul id="selInstruments" class="select col-6 col-xs-6 hidden"></ul>
              </div>
              
              <div id="pnlFX" class="tab row no-gutters controlPanel hidden">
                <header class="col-4 no-gutters tab-v br">
                  <button class="tab-header" data-tab="fxPanel" data-open="pnlDry">Dry</button>
                  <button class="tab-header" data-tab="fxPanel" data-open="pnlPart" onclick="loadPartFx()">Part</button>
                  <button class="tab-header" data-tab="" data-open="">Insert</button>
                  <button class="tab-header" data-tab="" data-open="">System</button>
                </header>
                <div class="col-8">
                  <div id="pnlDry" class="panel fxPanel hidden">
                    
                    <button id="btnDryPart" class="col-12 big-btn">None</button>
                    <button id="btnDryPart" class="col-12 big-btn">Bypass</button>
                    <button id="btnDryPart" class="col-12 big-btn">Unmount</button>
                    
                  </div>
                  <div id="pnlPart" class="panel fxPanel hidden">
                    <button id="btnpfx0" class="col-12 big-btn"></button>
                    <button id="btnpfx1" class="col-12 big-btn"></button>
                    <button id="btnpfx2" class="col-12 big-btn"></button>
                  </div>
                </div>
              </div>            
              <div id="pnlScript" class="tab row no-gutters controlPanel hidden">
                <div class="col-10">
                  <label for="commandline">&gt;</label>
                  <input id="commandLine" placeholder="Input parameter...">
                </div>
                <div class="col-2">
                  <button onclick="onScriptSend();">Send</button>
                </div>
              </div>
            </div> 
          </div> 
        </div> <!--col-10 -->        
      </div><!-- main row -->
    </div> <!--container-->

    
    <script type="text/javascript">
      window.zsession = {
        "instrument" : {},
        "instrumentList" : {},
        "bank" : '',
        "partID": 0
      };
            
      /* create a Instrument object */
      function listToInstrument(item) {
        if ('li' != $(item).prop('tagName').toLowerCase()) {
          console.log('Error: cannot translate item ' + $(item).prop('tagName'));
          return;
        }
        return {
          "path": $(item).attr('data-instrument'),
          "name" : $(item).text()
        }
      }
      
      /* Quickie to check if instrument if favorite */
      function isFavorite(instrument) {
        if (window.zsession.instrumentList.Favorites === undefined ||
            window.zsession.instrumentList.Favorites.length == 0)
        return false;
        
        return window.zsession.instrumentList.Favorites.
            filter((fav)=> {return fav.path == instrument.path})
            .length > 0;
      }
      
      const isObject = (obj) => {
        return Object.prototype.toString.call(obj) === '[object Object]';
      };
      
      /* Utility to do GET rest methods */
      function doQuery(rest, data, onDone) {
        return doAjax({method:'get', dataType: 'json', 
                  url: window.location.href+rest, 
                  data: data,
                  contentType: 'application/json; charset=utf-8'
        }, onDone);
      }
      
      function doAction(rest, data, onDone) {
        return doAjax( {method: 'post', 
          url: window.location.href+rest,
          data: JSON.stringify(data),
          contentType: 'application/json; charset=utf-8'
          }, onDone );
      }
      
      /* ajax function */
      function doAjax(params, onDone) {
        $.ajax(params)
        .done(function(data) {
            onDone(data);
          })
        .fail( function(jqXHR, textStatus, errorThrown) {
          $('#instrumentName').text(`Error #${errorThrown}`);  
        });
      }
      
      function onChangePart(index) {
        if (window.zsession.partID+index < 0)
          window.zsession.partID = 15;
        else if (window.zsession.partID+index > 15)
          window.zsession.partID = 0;
        else
          window.zsession.partID += index;
        $('#currentPart').text( ('0'+window.zsession.partID).substr(-2) );
        //retrieve part info
        doQuery('status/part', {id: window.zsession.partID}, (data) => {
          console.log(data);
          if (data.name == '') data.name = 'Unloaded';
          $('#instrumentName').text(`#${window.zsession.partID}: ${data.name}`);
        });
        
        //any active panel must be re-triggered
        $('.controlPanel tab-header.btn-selected').trigger('click');
      }
      /** loads part fx */
      function loadPartFx() {
        doQuery('status/partfx', {id: 0}, function(data){
          console.log(data);
            onPartLoad('btnpfx', data);
        });
      }
      
      /** updates button fx with same id */
      function onPartLoad(baseID, data) {
        for (let i = 0; i < 3; i++) {
          let button = `#${baseID}${i}`;
          if ('None' == data.efx[i].name) {
            $(button).addClass('hidden');
          } else {
            $(button).removeClass('hidden');
            $(button).text(data.efx[i].name);
          if (data.efx[i].bypass)
            $(button).removeClass('btn-selected');
          else
            $(button).addClass('btn-selected');
          }
        }
      }
      
      /* Bank button load */
      function onBanksButtonClick() {
        //Banks preloading
        if (window.zsession.banks === undefined) {
          doAjax({method:'get', dataType: 'json', url: window.location.href+"getBanks"},
          function(data) {
              window.zsession.banks = data;
              onBanksButtonClick();
              return;
          });
          return;
        }
        
        let banks = window.zsession.banks;
        let entry = '';
        let selectObject = $('#selBanks');
        selectObject.empty();
            
        banks.forEach( (value, index, array) => {
           let option = "<li data-bank=\""+value+"\">"+value+'</li>';
          // console.log(option);
           selectObject.append(option);
         });
             
         $('.controlPanel').addClass('hidden');
         $('#pnlBanks').removeClass('hidden');
      }
      
      function onBankSelection(selectedBank) {
        if (window.zsession.instrumentList[selectedBank] === undefined) {
          doAjax({method:'get', dataType: 'json', 
                  url: window.location.href+"getInstruments", 
                  data: {bank: selectedBank},
                  contentType: 'application/json; charset=utf-8'
            }, function(data){
              window.zsession.instrumentList[selectedBank] = data;
              onBankSelection(selectedBank);
              return;
            });
          return;
        }

        window.zsession.bank = selectedBank;
        
        let instruments = window.zsession.instrumentList[selectedBank];
        let entry = '';
        let selectObject = $('#selInstruments');
        selectObject.empty();
        
        instruments.forEach( (value, index, array) => {
          let entry = `<li data-instrument="${value.path}">${value.name}`;
                
          if (isFavorite(value))
            entry += '<span style="float:right"><i class="fas fa-star"></i></span>';
            
           selectObject.append(entry+"</li>");
           selectObject.removeClass('hidden');
        });
      }
      
      function onInstrumentSelection(instrument) {
        doAction("loadInstrument", {'instrument': instrument, 
          'id': window.zsession.partID}, (data) => {
            console.log('done');
//             $('#instrumentName').text(instrument.name);
              window.zsession.instrument = instrument;    
              $('#btnDoFavorite i').removeClass('far fas');
              $('#btnDoFavorite i').addClass( (isFavorite(instrument)) 
                                        ? 'fas' : 'far');
              onChangePart(0);
          })
        }

      function onScriptSend() {
        let data = $('#commandLine').val();
        doAjax({method:'post', url: window.location.href+"script",
                data: JSON.stringify({script: data}), 
                contentType: 'application/json; charset=utf-8'},
                function(){
        });
      }
      function setFavorite (instrument, value) {
        let action = (value) ? 'set' : 'unset';
        
        //First, we update server
        doAjax({method:'post', url: window.location.href+"setFavorite",
                data: JSON.stringify({"instrument":instrument, "action": action}), 
                contentType: 'application/json; charset=utf-8'},
        function() {
          
          //Then we update client, without ajax
          if (!value) {
            window.zsession.instrumentList.Favorites = 
            window.zsession.instrumentList.Favorites.filter( (entry) => {
              return (entry.path != instrument.path);});
          } else {
            window.zsession.instrumentList.Favorites.push(instrument);
          }
          
          //last we update display
          if (instrument.name == window.zsession.instrument.name) {
            $('#btnDoFavorite i').removeClass('far fas');
            $('#btnDoFavorite i').addClass((value == true) ? 'fas' : 'far'); 
          }
          
          let li = $('#selInstruments li.btn-selected');
          if (li !== undefined && li.attr('data-instrument') == instrument.path) {
            $(li).empty();
            $(li).text(instrument.name);
            if (value)
              $(li).append('<span style="float:right"><i class="fas fa-star"></i></span>');
          }
        });
      }
      
      
      /**
       Init 
       */
      $(document).ready(function() {
        /**
        Tab button management
        **/
          $('.tab-header').on('click', function() {
            let tab = $(this).closest('.tab');
            
            $(tab).find('> header .tab-header').removeClass('btn-selected');
            $(this).addClass('btn-selected');
            
            if ( $(this).attr('data-open') !== undefined) {
              let className= $(this).attr('data-tab');
              $('.'+className).addClass('hidden');
              $('#'+$(this).attr('data-open')).removeClass('hidden');
            }
          });
          
          onChangePart(0);
          
          // ::dryout part
          $('#btnDryPart').on('click', function () {
            console.log('called dry part');
            doAjax(
              {method:'post', url: window.location.href+"dryOut/part",
                data: JSON.stringify ({"value": "true", "part": 0}),
                contentType: 'application/json; charset=utf-8' },
              (data) => {
                console.log("done!");
                $('#btnDryPart').addClass('btn-selected');
              });
            });
                
          //Double filter is necessary or new elements won't be looked up
          $('ul.select').on('click', 'li', function(e){
            var item = $(e.target);
            item.addClass('btn-selected');
            item.siblings().removeClass('btn-selected');
            //eventId = '#' + $(item).parent().attr('data-event-id');
            //$(eventId).val(item.text());
          });
          
          $('#btnBanks').on('click', function() { onBanksButtonClick(); });
          
          $('#selBanks').on('click', 'li', function(e) {
            onBankSelection($(e.target).attr('data-bank'));
          });
          $('#selInstruments').on('click', 'li', function(e) {
            
            if ('span' == $(e.target).prop('tagName').toLowerCase()
                  || 'i' == $(e.target).prop('tagName').toLowerCase()) {
                    
              let instrument = listToInstrument($(e.target).closest('li'));
              setFavorite(instrument, false);
            } else
              onInstrumentSelection(listToInstrument($(e.target)));
          });
          
          $('#btnDoFavorite').on('click', function(){
            let instrument = window.zsession.instrument;
            setFavorite(instrument, (!isFavorite(instrument)));
          });
         
         doAjax({method:'get', dataType: 'json', 
                  url: window.location.href+"getInstruments", 
                  data: {bank: 'Favorites'},
                  contentType: 'application/json; charset=utf-8'},
          function(data) {
              window.zsession.instrumentList.Favorites = data;
              $('#instrumentName').text('Welcome to Zynthomania!');
          });
      });
    </script>
  </body>
</html>
