<!doctype html>


<html>
  <head>
    <link href="lnf.css" rel="stylesheet">
    <link href="bootstrap-grid.min.css" rel="stylesheet">
    <link href="fontawesome-free-5.15.3-web/css/all.css" rel="stylesheet">
    <script src="jquery/dist/jquery.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>

  <body>
    <input id="currentInstrument" type="hidden">
    
    <div class="">
      <div class="row no-gutters">
        
        <div class="col-12"> <!-- main body -->
          
          <table class="col-12 toolbar">
            <tr>
              <td><button id="btnDoFavorite"><i class="far fa-star big-icon"></i></button></td>
              <td><button onclick="onChangePart(-1)" class="big-btn">&lt;</button></td>
              <td><span id="currentPart" class="big-btn">1</span></td>
              <td><button onclick="onChangePart(1)" class="big-btn">&gt;</button></td>
            </tr>
          </table>
        
        <div class="col-12"><h3><span id="instrumentName">Welcome to Zynthomania! </span></h3></div>        
        
          <div class="row">
            <div class="col-12 tab">
              <header class="d-flex flex-row tab-h">
                <button class="tab-header" data-tab="controlPanel" data-open="pnlBanks" id="btnBanks"><a>Banks</a></button>
                <button class="tab-header" data-tab="controlPanel" data-open="pnlFX" id=""><a>FX</a></button>
                <button class="tab-header" data-tab="controlPanel" id=""><a>OSC</a></button>
                <button class="tab-header" data-tab="controlPanel" data-open="pnlScript"><a>Script</a></button>
              </header>
            
            <!--panels-->
              <div id="pnlBanks" class="row controlPanel no-gutters hidden">
                  <ul id="selBanks" class="select col-6 col-xs-6"></ul>
                  <ul id="selInstruments" class="select col-6 col-xs-6 hidden"></ul>
              </div>
              
              <div id="pnlFX" class="tab row no-gutters controlPanel hidden">
                <header class="col-4 no-gutters tab-v br">
                  <button class="tab-header" data-tab="fxPanel" data-open="pnlDry">Dry</button>
                  <button class="tab-header" data-tab="fxPanel" data-open="pnlPart" onclick="queryPartFX()">Part</button>
                  <button class="tab-header" data-tab="" data-open="">Insert</button>
                  <button class="tab-header" data-tab="" data-open="">System</button>
                </header>
                <div class="col-8">
                  <div id="pnlDry" class="panel fxPanel hidden">
                    
                    <button id="btnDryPart" class="col-12 big-btn">None</button>
                    <button id="btnDryPart" class="col-12 big-btn">Bypass</button>
                    <button id="btnDryPart" class="col-12 big-btn">Unmount</button>
                    
                  </div>
                  <div id="pnlPart" class="panel fxPanel hidden row">
                    <div class="col-8">
                      <button class="fx-btn col-12 big-btn" data-osc="/part/partefx0" id="btnpfx0" onclick="onFXPartButtonSelect(0)"></button>
                      <button class="fx-btn col-12 big-btn" data-osc="/part/partefx1" id="btnpfx1" onclick="onFXPartButtonSelect(1)"></button>
                      <button class="fx-btn col-12 big-btn" data-osc="/part/partefx2" id="btnpfx2" onclick="onFXPartButtonSelect(2)"></button>
                    </div>
                    <div class="col-4 hidden" id="fxPartPopup">
                      <button class="big-btn col-12" id="fxBypass" onclick="actionBypassPartFX();"><i class="big-icon fas fa-volume-mute"></i></button>
                      <button class="big-btn col-12">&lt;</button>
                      <button class="big-btn col-12">&gt;</button>
                      <button class="hidden big-btn col-12 pfx-preset">+</button>
                      <button class="hidden big-btn col-12 pfx-preset">-</button>
                    </div>
                    <!--
                    <table class="toolbar col-12">
                      <tr>
                        <td><button class="big-btn">&lt;</button></td>
                        <td><button class="big-btn">&gt;</button></td>
                        <td><button class="big-btn">+</button></td>
                        <td><button class="big-btn">-</button></td>
                      </tr>
                    </table>
                    -->
                  </div>
                </div>
              </div>            
              <div id="pnlScript" class="tab row no-gutters controlPanel hidden">
                <div class="col-10">
                  <label for="commandline">&gt;</label>
                  <input id="commandLine" placeholder="Input parameter...">
                </div>
                <div class="col-2">
                  <button onclick="onScriptSend();">Send</button>
                </div>
              </div>
            </div> 
          </div> 
        </div> <!--col-10 -->        
      </div><!-- main row -->
    </div> <!--container-->

    
    <script type="text/javascript">
      window.zsession = {
        "instrument" : {},
        "bank" : '',
        "partID": 0,
        "partefx" : new Array(15),
         fx : { fxpath : ''},
         banks : {}
      };
            
      /* create a Instrument object */
      function listToInstrument(item) {
        if ('li' != $(item).prop('tagName').toLowerCase()) {
          console.log('Error: cannot translate item ' + $(item).prop('tagName'));
          return;
        }
        return {
          "path": $(item).attr('data-instrument'),
          "name" : $(item).text()
        }
      }
      
      /* Quickie to check if instrument if favorite */
      function isFavorite(instrument) {
        if (window.zsession.banks['Favorites'] === undefined ||
            window.zsession.banks['Favorites'].length == 0)
        return false;
        
        return window.zsession.banks['Favorites'].filter
                ((fav)=> {return fav.path == instrument.path})
            .length > 0;
      }
      
      const isObject = (obj) => {
        return Object.prototype.toString.call(obj) === '[object Object]';
      };
      
      /* Utility to do GET rest methods */
      function doQuery(rest, data, onDone) {
        return doAjax({method:'get', dataType: 'json', 
                  url: window.location.href+rest, 
                  data: data,
                  contentType: 'application/json; charset=utf-8'
        }, onDone);
      }
      
      function doAction(rest, data, onDone) {
        return doAjax( {method: 'post', 
          url: window.location.href+rest,
          data: JSON.stringify(data),
          contentType: 'application/json; charset=utf-8'
          }, onDone );
      }
      
      /* ajax function */
      function doAjax(params, onDone) {
        $.ajax(params)
        .done(function(data) {
            onDone(data);
          })
        .fail( function(jqXHR, textStatus, errorThrown) {
          $('#instrumentName').text(`Error #${errorThrown}`);  
        });
      }
      
      function onChangePart(index) {
        if (window.zsession.partID+index < 0)
          window.zsession.partID = 15;
        else if (window.zsession.partID+index > 15)
          window.zsession.partID = 0;
        else
          window.zsession.partID += index;
        $('#currentPart').text( ('0'+window.zsession.partID).substr(-2) );
        //retrieve part info
        doQuery('status/part', {id: window.zsession.partID}, (data) => {
          console.log(data);
          if (data.name == '') data.name = 'Unloaded';
          $('#instrumentName').text(`#${window.zsession.partID}: ${data.name}`);
        });
        
        //any active panel must be re-triggered
        $('.controlPanel tab-header.btn-selected').trigger('click');
      }
      
      /** loads part fx */
      function queryPartFX() {
        doQuery('status/partfx', {id: window.zsession.partID}, function(data){
          console.log(data);
            window.zsession.partefx[window.zsession.partID] = data.efx;
            onFXLoad('btnpfx', data);
        });
      }
      
      /** updates button fx with same id */
      function onFXLoad(baseID, data) {
        for (let i = 0; i < data.efx.length; i++) {
          
          let button = `#${baseID}${i}`;
          
          //$(button).removeClass('hidden');
          $(button).removeClass('btn-selected');
          $(button).text( (data.efx[i].preset === undefined)
                          ? data.efx[i].name
                          : `${data.efx[i].name}/${data.efx[i].preset}`
                        );
        }
      }
      
      function onFXPartButtonSelect(fxid) {
        $('.fx-btn').removeClass('btn-selected');
        $(`#btnpfx${fxid}`).addClass('btn-selected');
        $('#fxPartPopup').removeClass('hidden');
        
        let pfx = window.zsession.partefx[window.zsession.partID][fxid];
        $('#fxBypass').removeClass('btn-selected');
        if (pfx.bypass) $('#fxBypass').addClass('btn-selected');
        
        if ('None' == pfx.name)
          $('.pfx-preset').addClass('hidden');
        else
          $('.pfx-preset').removeClass('hidden');
        
        window.zsession.fx.pefx = fxid;
      }
      
     function actionBypassPartFX() {
         let pID = window.zsession.partID;
         let fxID = window.zsession.fx.pefx;
         
         let path = `/part${pID}/Pefxbypass${fxID}`;
         path += (window.zsession.partefx[pID][fxID].bypass) ? ' F' : ' T';
         console.log(`path: ${path}`);
         
         doAction('script', { script: path }, (data) => {
            window.zsession.partefx[pID][fxID].bypass = 
            !window.zsession.partefx[pID][fxID].bypass;
            
            if (!window.zsession.partefx[pID][fxID].bypass)
              $('#fxBypass').removeClass('btn-selected');
            else
              $('#fxBypass').addClass('btn-selected');
         });
      }
     
      /* Bank button load */
      function queryBankList() {
        //Banks preloading
        if (Object.keys(window.zsession.banks).length <= 1) {
          doQuery('getBanks', null, (data) => {
            data.forEach( (item) => {
              window.zsession.banks[item] = [];
              
            queryBankList();
            return;
            });
          })
          return;
        }
        
        let banks = window.zsession.banks;
        let entry = '';
        let selectObject = $('#selBanks');
        selectObject.empty();
            
        Object.keys(banks).forEach( (key) => {
          selectObject.append('<li data-bank="'+key+'">'+key+'</li>');
      
        });
             
         $('.controlPanel').addClass('hidden');
         $('#pnlBanks').removeClass('hidden');
      }
      
      function queryBank(selectedBank) {
        if (window.zsession.banks[selectedBank].length == 0) {
          doQuery('getInstruments', {bank: selectedBank}, (data) => {
            window.zsession.banks[selectedBank] = data;
            queryBank(selectedBank);
            return;
          });
          return;
        }

        window.zsession.bank = selectedBank;
        
        let instruments = window.zsession.banks[selectedBank];
        let entry = '';
        let selectObject = $('#selInstruments');
        selectObject.empty();
        
        instruments.forEach( (value, index, array) => {
          let entry = `<li data-instrument="${value.path}">${value.name}`;
                
          if (isFavorite(value))
            entry += '<span style="float:right"><i class="fas fa-star"></i></span>';
            
           selectObject.append(entry+"</li>");
           selectObject.removeClass('hidden');
        });
      }
      
      function onInstrumentSelection(instrument) {
        doAction("loadInstrument", {'instrument': instrument, 
          'id': window.zsession.partID}, (data) => {
            console.log('done');
//             $('#instrumentName').text(instrument.name);
              window.zsession.instrument = instrument;    
              $('#btnDoFavorite i').removeClass('far fas');
              $('#btnDoFavorite i').addClass( (isFavorite(instrument)) 
                                        ? 'fas' : 'far');
              onChangePart(0);
          })
        }

      function onScriptSend() {
        let data = $('#commandLine').val();
        doAjax({method:'post', url: window.location.href+"script",
                data: JSON.stringify({script: data}), 
                contentType: 'application/json; charset=utf-8'},
                function(){
        });
      }
      function setFavorite (instrument, value) {
        let action = (value) ? 'set' : 'unset';
        
        //First, we update server
        doAjax({method:'post', url: window.location.href+"setFavorite",
                data: JSON.stringify({"instrument":instrument, "action": action}), 
                contentType: 'application/json; charset=utf-8'},
        function() {
          
          //Then we update client, without ajax
          if (!value) {
            window.zsession.banks['Favorites']= 
            window.zsession.banks.Favorites.filter( (entry) => {
              return (entry.path != instrument.path);});
          } else {
            window.zsession.banks.Favorites.push(instrument);
          }
          
          //last we update display
          if (instrument.name == window.zsession.instrument.name) {
            $('#btnDoFavorite i').removeClass('far fas');
            $('#btnDoFavorite i').addClass((value == true) ? 'fas' : 'far'); 
          }
          
          let li = $('#selInstruments li.btn-selected');
          if (li !== undefined && li.attr('data-instrument') == instrument.path) {
            $(li).empty();
            $(li).text(instrument.name);
            if (value)
              $(li).append('<span style="float:right"><i class="fas fa-star"></i></span>');
          }
        });
      }
      
      
      /**
       Init 
       */
      $(document).ready(function() {
        /**
        Tab button management
        **/
          $('.tab-header').on('click', function() {
            let tab = $(this).closest('.tab');
            
            $(tab).find('> header .tab-header').removeClass('btn-selected');
            $(this).addClass('btn-selected');
            
            if ( $(this).attr('data-open') !== undefined) {
              let className= $(this).attr('data-tab');
              $('.'+className).addClass('hidden');
              $('#'+$(this).attr('data-open')).removeClass('hidden');
            }
          });
          
          
          //Double filter is necessary or new elements won't be looked up
          $('ul.select').on('click', 'li', function(e){
            var item = $(e.target);
            item.addClass('btn-selected');
            item.siblings().removeClass('btn-selected');
            //eventId = '#' + $(item).parent().attr('data-event-id');
            //$(eventId).val(item.text());
          });
          
          /**
          Button actions
          */
          $('#btnBanks').on('click', function() { queryBankList(); });
          $('#selBanks').on('click', 'li', function(e) {
            queryBank($(e.target).attr('data-bank'));
          });
          $('#selInstruments').on('click', 'li', function(e) {
            
            if ('span' == $(e.target).prop('tagName').toLowerCase()
                  || 'i' == $(e.target).prop('tagName').toLowerCase()) {
                    
              let instrument = listToInstrument($(e.target).closest('li'));
              setFavorite(instrument, false);
            } else
              onInstrumentSelection(listToInstrument($(e.target)));
          });
          
          $('#btnDoFavorite').on('click', function(){
            let instrument = window.zsession.instrument;
            setFavorite(instrument, (!isFavorite(instrument)));
          });
         
          
          /**
          Init actions
          - get favorites
          - update part names
          */
          doQuery('getInstruments', {bank: 'Favorites'}, 
            function(data) {
                window.zsession.banks['Favorites'] = data;
                $('#instrumentName').text('Welcome to Zynthomania!');
          });
          
          onChangePart(0);
      });
    </script>
  </body>
</html>
