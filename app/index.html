<!doctype html>


<html>
  <head>
    <link href="lnf.css" rel="stylesheet">
    <link href="bootstrap-grid.min.css" rel="stylesheet">
    <link href="fontawesome-5-css/css/fontawesome-all.css" rel="stylesheet">
    <script src="jquery/dist/jquery.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>

  <body>
    <input id="currentPreset" type="hidden">
    
    <div class="container">
      <div class="row">
        <div class="col-10 col-xs-10">
          <h3 id="presetName">Welcome to Zynthomania!</h3>
        </div>
        <div class="col-2 col-xs-2">
          <h3><span id="btnDoFavorite"><i class="far fa-star"></i></span>
          </h3>
        </div>
      </div>
      <div class="row">
        <div class="col-xs-10">
          <header class="d-flex flex-row">
            <button class="bar-1" id="btnBanks"><a>Banks</a></button>
            <button class="bar-1" id=""><a>FX</a></button>
            <button class="bar-1" id=""><a>OSC</a></button>
            <button class="bar-1" id=""><a>Presets</a></button>
          </header>
          
          <!--panels-->
          <div id="pnlBanks" class="row controlPanel hidden">
              <ul id="selBanks" class="select col-6 col-xs-6"></ul>
              <ul id="selPresets" class="select col-6 col-xs-6 hidden"></ul>
          </div>
          
        </div> <!--col-10 -->
      </div> <!-- main row -->
    </div> <!--container-->

    
    <script type="text/javascript">
      window.zsession = {
        "preset" : {},
        "presetList" : {},
        "bank" : ''
      };
            
      /* create a Preset object */
      function listToPreset(item) {
        if ('li' != $(item).prop('tagName').toLowerCase()) {
          console.log('Error: cannot translate item ' + $(item).prop('tagName'));
          return;
        }
        return {
          "path": $(item).attr('data-preset'),
          "name" : $(item).text()
        }
      }
      
      /* Quickie to check if preset if favorite */
      function isFavorite(preset) {
        if (window.zsession.presetList.Favorites === undefined ||
            window.zsession.presetList.Favorites.length == 0)
        return false;
        
        return window.zsession.presetList.Favorites.
            filter((fav)=> {return fav.path == preset.path})
            .length > 0;
      }
      
      /* ajax function */
      function doAjax(params, onDone) {
        $.ajax(params)
        .done(function(data) {
            onDone(data);
          })
        .fail( function(jqXHR, textStatus, errorThrown) {
          $('#presetName').text(`Error #${errorThrown}`);  
        });
      }
      
      /* Bank button load */
      function onBanksButtonClick() {
        //Banks preloading
        if (window.zsession.banks === undefined) {
          doAjax({method:'get', dataType: 'json', url: window.location.href+"getBanks"},
          function(data) {
              window.zsession.banks = data;
              onBanksButtonClick();
              return;
          });
          return;
        }
        
        let banks = window.zsession.banks;
        let entry = '';
        let selectObject = $('#selBanks');
        selectObject.empty();
            
        banks.forEach( (value, index, array) => {
           let option = "<li data-bank=\""+value+"\">"+value+'</li>';
          // console.log(option);
           selectObject.append(option);
         });
             
         $('.controlPanel').addClass('hidden');
         $('#pnlBanks').removeClass('hidden');
      }
      
      function onBankSelection(selectedBank) {
        if (window.zsession.presetList[selectedBank] === undefined) {
          doAjax({method:'get', dataType: 'json', 
                  url: window.location.href+"getPresets", 
                  data: {bank: selectedBank},
                  contentType: 'application/json; charset=utf-8'
            }, function(data){
              window.zsession.presetList[selectedBank] = data;
              onBankSelection(selectedBank);
              return;
            });
          return;
        }
        
        window.zsession.bank = selectedBank;
        
        let presets = window.zsession.presetList[selectedBank];
        let entry = '';
        let selectObject = $('#selPresets');
        selectObject.empty();
        
        presets.forEach( (value, index, array) => {
          let entry = `<li data-preset="${value.path}">${value.name}`;
                
          if (isFavorite(value))
            entry += '<span style="float:right"><i class="fas fa-star"></i></span>';
            
           selectObject.append(entry+"</li>");
           selectObject.removeClass('hidden');
        });
      }
      
      function onPresetSelection(preset) {
        doAjax({method:'post', url: window.location.href+"loadPreset",
                data: JSON.stringify({"preset":preset}), 
                contentType: 'application/json; charset=utf-8'},
                function(){
             $('#presetName').text(preset.name);
                window.zsession.preset = preset;    
                $('#btnDoFavorite i').removeClass('far fas');
                $('#btnDoFavorite i').addClass( (isFavorite(preset)) 
                                          ? 'fas' : 'far');        
        });
      }
      
      function setFavorite (preset, value) {
        let action = (value) ? 'set' : 'unset';
        
        //First, we update server
        doAjax({method:'post', url: window.location.href+"setFavorite",
                data: JSON.stringify({"preset":preset, "action": action}), 
                contentType: 'application/json; charset=utf-8'},
        function() {
          
          //Then we update client, without ajax
          if (!value) {
            window.zsession.presetList.Favorites = 
            window.zsession.presetList.Favorites.filter( (entry) => {
              return (entry.path != preset.path);});
          } else {
            window.zsession.presetList.Favorites.push(preset);
          }
          
          //last we update display
          if (preset.name == window.zsession.preset.name) {
            $('#btnDoFavorite i').removeClass('far fas');
            $('#btnDoFavorite i').addClass((value == true) ? 'fas' : 'far'); 
          }
          
          let li = $('#selPresets li.btn-selected');
          if (li !== undefined && li.attr('data-preset') == preset.path) {
            $(li).empty();
            $(li).text(preset.name);
            if (value)
              $(li).append('<span style="float:right"><i class="fas fa-star"></i></span>');
          }
        });
      }
      
      
      /* Init */
      $(document).ready(function() {
          $('.bar-1').on('click', function() {
            console.log('test');
            $('.bar-1').removeClass('btn-selected');
            $(this).addClass('btn-selected');
          });
          
          //Double filter is necessary or new elements won't be looked up
          $('ul.select').on('click', 'li', function(e){
            var item = $(e.target);
            item.addClass('btn-selected');
            item.siblings().removeClass('btn-selected');
            //eventId = '#' + $(item).parent().attr('data-event-id');
            //$(eventId).val(item.text());
          });
          
          $('#btnBanks').on('click', function() { onBanksButtonClick(); });
          
          $('#selBanks').on('click', 'li', function(e) {
            onBankSelection($(e.target).attr('data-bank'));
          });
          $('#selPresets').on('click', 'li', function(e) {
            
            if ('span' == $(e.target).prop('tagName').toLowerCase()
                  || 'i' == $(e.target).prop('tagName').toLowerCase()) {
                    
              let preset = listToPreset($(e.target).closest('li'));
              setFavorite(preset, false);
            } else
              onPresetSelection(listToPreset($(e.target)));
          });
          
          $('#btnDoFavorite').on('click', function(){
            let preset = window.zsession.preset;
            setFavorite(preset, (!isFavorite(preset)));
          });
         
         doAjax({method:'get', dataType: 'json', 
                  url: window.location.href+"getPresets", 
                  data: {bank: 'Favorites'},
                  contentType: 'application/json; charset=utf-8'},
          function(data) {
              window.zsession.presetList.Favorites = data;
              $('#presetName').text('Welcome to Zynthomania!');
          });
      });
    </script>
  </body>
</html>
